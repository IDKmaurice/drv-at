<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <script src="js/vue.min.js"></script>
        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="css/print/main.min.css">
        <script>
            const $ = require('jquery')
            const fs = require('fs')
            const dialog = require('electron').remote.dialog;
            const tooltip = require('electron-tooltip')
            const settings = require('electron-settings')
            const ipc = require('electron').ipcRenderer;
        </script>
    </head>
    <body>
        <div id="app">
            <div class="viewport" id="viewport">
                <div class="page">
                    <h2>PRINT - VORSCHAU</h2><br>
                    Dies ist die Printvorschau.<br>
                    Sie dient als Übersicht und Auswahl für alle Drucke.
                </div>
            </div>
            <div class="print-sidebar">
                <div class="tab-holder">
                    <div class="tab" :class="{'active' : pageState == 'FRONT'}" @click="pageState = 'FRONT'">Vorderseite</div>
                    <div class="tab" :class="{'active' : pageState == 'BACK'}" @click="pageState = 'BACK'">Rückseite</div>
                </div>
                <div v-for="entry in main.doc.entries" class="entry">
                    {{entry.firstname}}
                </div>
            </div>
            <div class="print-footer">
                <div class="button ghost-button" onclick="closePrint()">Schließen</div>
                <div class="button" onclick="triggerPrint()">Auswahl drucken</div>
            </div>
        </div>
    </body>
    <script>

        app = new Vue({
            el:'#app',
            data: {
                scale: 0.8,
                pos: {x:-130,y:-45},
                grab: {startx: 0, starty: 0, isGrabbing: false},
                pageState: 'FRONT',
                main: {
                    doc:{
                        entries: []
                    }
                }
            }
        })

        tooltip({ style: { backgroundColor: '#292828', borderRadius: '4px' } })
        setPagePosScale()

        ipc.on ('print-info-return', (event, values_raw) => {
            app.main = JSON.parse(values_raw)
        })

        let viewport = document.getElementById('viewport')

        viewport.addEventListener('wheel', function (e) {
            if (e.deltaY < 0 && app.scale < 3) app.scale = app.scale * 1.1 // Make plane bigger
            if (e.deltaY > 0 && app.scale > 0.2) app.scale = app.scale / 1.1 // Make plane smaller
            setPagePosScale()
        })

        viewport.addEventListener('mousedown', function (e) {
            app.grab.isGrabbing = true
            app.grab.startx = e.clientX
            app.grab.starty = e.clientY
        })

        viewport.addEventListener('mouseup', function (e) {
            app.grab.isGrabbing = false
        })

        viewport.addEventListener('mouseout', function (e) {
            app.grab.isGrabbing = false
        })

        viewport.addEventListener('mousemove', function (e) {
            if(app.grab.isGrabbing){
                app.pos.x += e.clientX - app.grab.startx
                app.pos.y += e.clientY - app.grab.starty
                app.grab.startx = e.clientX
                app.grab.starty = e.clientY
                setPagePosScale()
            }
        })

        function setPagePosScale() {
            $('.page').css('transform', `translate(${app.pos.x}px,${app.pos.y}px) scale(${app.scale})`)
        }



        function closePrint() {
            ipc.send('print-close')
        }



        function triggerPrint() {
            dialog.showOpenDialog({properties: ['openDirectory']}, (filepath) => {

                $('.page-front').css('display','inline-block')
                $('.page-back').css('display','none')

                ipc.send('print-to-pdf',[filepath[0],'seite_1.pdf',true])

            })
        }


        ipc.on('print-front-ready', (event, filepath) => {

            $('.page-front').css('display','none')
            $('.page-back').css('display','inline-block')

            ipc.send('print-to-pdf',[filepath,'seite_2.pdf',false])

            closePrint()
        });
    </script>

    <!-- Just here to let me F5 the program -> delete when production -->
    <script src="renderer.js"></script>
</html>